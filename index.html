<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube í†µí•© ë¶„ì„ê¸° (ê°œì¸ìš©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; font-family:"ë§‘ì€ ê³ ë”•",system-ui,sans-serif }
    .btn { padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff }
    .btn:hover { background:#f3f4f6 }
    .btn-primary { background:#111827; color:#fff; border-color:#111827 }
    .btn-primary:hover { background:#1f2937 }
    .btn-active{ background:#111827!important; color:#fff!important; border-color:#111827!important }
    .th { background:#0ea5e9; color:#fff; font-weight:700 }
    .num{ font-variant-numeric: tabular-nums }
    .skel{animation:pulse 1.4s ease-in-out infinite;background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%}
    @keyframes pulse {0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="flex items-center gap-2 mb-4">
      <span class="text-2xl">ğŸ“Š</span>
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">YouTube í†µí•© ë¶„ì„ê¸°</h1>
      <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">ê°œì¸ìš© Â· ìë™ ì‹¤í–‰</span>
    </header>

    <!-- ì•Œë¦¼/ì—ëŸ¬ ì˜ì—­ -->
    <div id="notice" class="hidden mb-4 p-3 rounded-md text-sm"></div>

    <!-- ì…ë ¥/ì»¨íŠ¸ë¡¤ -->
    <section class="bg-white rounded-xl border border-gray-200 p-4 sm:p-5 shadow-sm mb-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">í‚¤ì›Œë“œ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
          <textarea id="keywords" rows="4" class="w-full rounded-lg border-gray-300 focus:ring-0"
          >ê±´ê°• ì •ë³´
íŠ¸ëŸ¼í”„ ê´€ì„¸</textarea>
          <p class="text-xs text-gray-500 mt-1">ì˜ˆ: â€˜ê±´ê°• ì •ë³´â€™, â€˜íŠ¸ëŸ¼í”„ ê´€ì„¸â€™ ë“± ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥</p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ê°„ ì„ íƒ</label>
            <div id="daysBtns" class="flex flex-wrap gap-2">
              <!-- ìš”ì²­í•˜ì‹  ê¸°ë³¸ ì„¸íŒ…ê°’ë“¤ -->
              <button class="btn btn-active" data-days="3">3ì¼</button>
              <button class="btn" data-days="7">7ì¼</button>
              <button class="btn" data-days="15">15ì¼</button>
              <button class="btn" data-days="30">30ì¼</button>
              <button class="btn" data-days="90">3ê°œì›”</button>
              <button class="btn" data-days="180">6ê°œì›”</button>
              <button class="btn" data-days="365">1ë…„</button>
            </div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="run" class="btn btn-primary">ë¶„ì„ ì‹¤í–‰</button>
            <button id="reset" class="btn">ì „ì²´ ë³´ê¸°</button>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="top10Eng" class="btn">ì°¸ì—¬ìœ¨ ìƒìœ„ 10% ë³´ê¸°</button>
            <button id="top10ViewsPct" class="btn">ì¡°íšŒìˆ˜ ìƒìœ„ 10% ë³´ê¸°</button>
            <button id="top10ViewsAbs" class="btn">ì¡°íšŒìˆ˜ ìƒìœ„ 10ê°œ ë³´ê¸°</button>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="exportCsv" class="btn">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <section class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
      <table class="min-w-[980px] w-full border-collapse">
        <thead>
          <tr class="th">
            <th class="p-3 text-left">ì¸ë„¤ì¼</th>
            <th class="p-3 text-left">í‚¤ì›Œë“œ</th>
            <th class="p-3 text-left">ì œëª©</th>
            <th class="p-3 text-left">ì±„ë„ëª… <span class="opacity-80">(êµ¬ë…ì)</span></th>
            <th class="p-3 text-right">ì¡°íšŒìˆ˜</th>
            <th class="p-3 text-right">ì¢‹ì•„ìš”</th>
            <th class="p-3 text-right">ëŒ“ê¸€</th>
            <th class="p-3 text-right">ì°¸ì—¬ìœ¨%</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </div>

  <script>
    /* ====== ì—¬ê¸° API í‚¤ í•œ ë²ˆë§Œ ë„£ìœ¼ë©´ ë! ====== */
    const API_KEY = "AIzaSyAMCdmq2Hz6z5da1QbzYVMf7W5uTATM9vg"; // â† YouTube Data API v3 í‚¤

    /* ====== ìœ í‹¸ ====== */
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>[...document.querySelectorAll(s)];
    const fmt = (n)=>Number(n||0).toLocaleString("ko-KR");
    const notice = $("#notice");
    const tbody = $("#tbody");

    function setNotice(type, html){
      notice.className = "mb-4 p-3 rounded-md text-sm";
      if(type==="error"){ notice.classList.add("bg-red-50","text-red-700"); }
      else { notice.classList.add("bg-blue-50","text-blue-700"); }
      notice.innerHTML = html;
      notice.classList.remove("hidden");
    }
    function hideNotice(){ notice.classList.add("hidden"); }

    function isoNDaysAgo(days){
      const d=new Date(); d.setDate(d.getDate()-Number(days||7));
      return d.toISOString();
    }

    function renderLoading(rows=8){
      tbody.innerHTML = "";
      for(let i=0;i<rows;i++){
        tbody.insertAdjacentHTML("beforeend", `
          <tr class="border-t">
            <td class="p-3"><div class="skel w-[120px] h-[68px] rounded-md"></div></td>
            <td class="p-3"><div class="skel w-16 h-5 rounded"></div></td>
            <td class="p-3"><div class="skel w-72 h-5 rounded"></div></td>
            <td class="p-3"><div class="skel w-56 h-5 rounded"></div></td>
            <td class="p-3 text-right"><div class="skel w-16 h-5 rounded ml-auto"></div></td>
            <td class="p-3 text-right"><div class="skel w-16 h-5 rounded ml-auto"></div></td>
            <td class="p-3 text-right"><div class="skel w-16 h-5 rounded ml-auto"></div></td>
            <td class="p-3 text-right"><div class="skel w-16 h-5 rounded ml-auto"></div></td>
          </tr>`);
      }
    }

    function rowHTML(v){
      const subFmt = (n)=>{
        const x=Number(n||0);
        if(x>=1_000_000) return (x/1_000_000).toFixed(1)+"ë°±ë§Œ";
        if(x>=10_000) return (x/10_000).toFixed(1)+"ë§Œ";
        return fmt(x);
      };
      return `
        <tr class="border-t hover:bg-gray-50">
          <td class="p-3">
            <a href="${v.url}" target="_blank" rel="noopener">
              <img src="${v.thumbnail}" class="w-[120px] h-[68px] object-cover rounded-md border" />
            </a>
          </td>
          <td class="p-3 text-sm text-gray-700">${v.keyword}</td>
          <td class="p-3">
            <a href="${v.url}" target="_blank" class="text-sm font-medium text-blue-700 hover:underline">${v.title}</a>
          </td>
          <td class="p-3 text-sm">
            <a href="${v.channelUrl}" target="_blank" class="hover:underline">${v.channelTitle}</a>
            <span class="text-gray-400 ml-1">(êµ¬ë…ì <span class="num">${subFmt(v.subscribers)}</span>)</span>
          </td>
          <td class="p-3 text-right num">${fmt(v.views)}</td>
          <td class="p-3 text-right num">${fmt(v.likes)}</td>
          <td class="p-3 text-right num">${fmt(v.comments)}</td>
          <td class="p-3 text-right num font-semibold">${v.engagement.toFixed(2)}</td>
        </tr>
      `;
    }

    function render(list){
      tbody.innerHTML = list.length
        ? list.map(rowHTML).join("")
        : `<tr><td colspan="8" class="p-8 text-center text-gray-500">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    }

    /* ====== YouTube API ====== */
    async function yt(url){
      const r = await fetch(url);
      const j = await r.json();
      if(!r.ok || j.error){
        throw new Error(j?.error?.message || "YouTube API ì˜¤ë¥˜");
      }
      return j;
    }

    async function searchByKeyword(q, publishedAfter, max=20){
      const url = new URL("https://www.googleapis.com/youtube/v3/search");
      url.search = new URLSearchParams({
        key: API_KEY, part: "snippet",
        q, type:"video", order:"viewCount",
        maxResults:String(Math.min(max,50)),
        publishedAfter
      }).toString();
      const data = await yt(url);
      return (data.items||[]).map(i=>i.id?.videoId).filter(Boolean);
    }

    async function fetchVideosStats(ids){
      if(!ids.length) return [];
      const url = new URL("https://www.googleapis.com/youtube/v3/videos");
      url.search = new URLSearchParams({
        key: API_KEY, part:"snippet,statistics", id: ids.join(",")
      }).toString();
      const data = await yt(url);
      return data.items||[];
    }

    async function fetchChannelsSubs(ids){
      if(!ids.length) return {};
      const url = new URL("https://www.googleapis.com/youtube/v3/channels");
      url.search = new URLSearchParams({
        key: API_KEY, part:"statistics", id: ids.join(",")
      }).toString();
      const data = await yt(url);
      const map = {};
      (data.items||[]).forEach(c=>{
        map[c.id] = Number(c.statistics?.subscriberCount||0);
      });
      return map;
    }

    /* ====== ë©”ì¸ ë¶„ì„ ====== */
    let ALL = [];      // ì „ì²´ ê²°ê³¼
    let CURRENT = [];  // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ê²°ê³¼

    async function analyze(days){
      try{
        if(!API_KEY || API_KEY.includes("ì—¬ê¸°ì—_")){
          setNotice("error","â— API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.html ìƒë‹¨ì˜ <b>API_KEY</b> ê°’ì„ ë³¸ì¸ í‚¤ë¡œ êµì²´í•˜ì„¸ìš”.");
          render([]);
          return;
        }
        hideNotice();
        renderLoading();

        const publishedAfter = isoNDaysAgo(days);
        const keywords = $("#keywords").value.split("\n").map(s=>s.trim()).filter(Boolean);
        let combined = [];

        for(const kw of keywords){
          // 1) ê²€ìƒ‰ â†’ ì˜ìƒ ID ìˆ˜ì§‘
          const ids = await searchByKeyword(kw, publishedAfter, 20);
          if(!ids.length) continue;

          // 2) ë¹„ë””ì˜¤ í†µê³„
          const videos = await fetchVideosStats(ids);

          // 3) ì±„ë„ êµ¬ë…ì ìˆ˜ ë§¤í•‘
          const channelIds = [...new Set(videos.map(v=>v.snippet?.channelId).filter(Boolean))];
          const subsMap = await fetchChannelsSubs(channelIds);

          const items = videos.map(v=>{
            const s = v.statistics||{};
            const views = Number(s.viewCount||0);
            const likes = Number(s.likeCount||0);
            const comments = Number(s.commentCount||0);
            const engagement = views ? ((likes+comments)/views)*100 : 0;

            return {
              keyword: kw,
              title: v.snippet?.title||"",
              url: `https://www.youtube.com/watch?v=${v.id}`,
              thumbnail: v.snippet?.thumbnails?.medium?.url || v.snippet?.thumbnails?.high?.url || "",
              channelTitle: v.snippet?.channelTitle||"",
              channelUrl: v.snippet?.channelId ? `https://www.youtube.com/channel/${v.snippet.channelId}` : "#",
              subscribers: subsMap[v.snippet?.channelId]||0,
              views, likes, comments, engagement
            };
          });

          combined.push(...items);
        }

        // ê¸°ë³¸ ì •ë ¬: ì¡°íšŒìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
        combined.sort((a,b)=>b.views-a.views);

        ALL = combined;
        CURRENT = [...ALL];
        render(CURRENT);
        setNotice("info", `âœ… ì´ <b>${fmt(CURRENT.length)}</b>ê°œ ì˜ìƒ ë¶„ì„ ì™„ë£Œ Â· ê¸°ê°„: <b>${days}ì¼</b>`);
      }catch(err){
        console.error(err);
        render([]);
        setNotice("error", `â— ${err.message}`);
      }
    }

    /* ====== í•„í„°/ì•¡ì…˜ ====== */
    function showAll(){ CURRENT = [...ALL]; render(CURRENT); }

    function top10Engagement(){
      if(!ALL.length) return;
      const sorted = [...ALL].sort((a,b)=>b.engagement-a.engagement);
      const cut = Math.max(1, Math.floor(sorted.length*0.1));
      CURRENT = sorted.slice(0, cut);
      render(CURRENT);
      setNotice("info", `ğŸ¯ ì°¸ì—¬ìœ¨ ìƒìœ„ 10% (ì´ ${fmt(CURRENT.length)}ê°œ)`);
    }

    function top10ViewsPercent(){
      if(!ALL.length) return;
      const sorted = [...ALL].sort((a,b)=>b.views-a.views);
      const cut = Math.max(1, Math.floor(sorted.length*0.1));
      CURRENT = sorted.slice(0, cut);
      render(CURRENT);
      setNotice("info", `ğŸ¯ ì¡°íšŒìˆ˜ ìƒìœ„ 10% (ì´ ${fmt(CURRENT.length)}ê°œ)`);
    }

    function top10ViewsAbsolute(){
      if(!ALL.length) return;
      const sorted = [...ALL].sort((a,b)=>b.views-a.views);
      CURRENT = sorted.slice(0, 10);
      render(CURRENT);
      setNotice("info", `ğŸ¯ ì¡°íšŒìˆ˜ ìƒìœ„ 10ê°œ`);
    }

    function exportCSV(){
      const rows = [
        ["í‚¤ì›Œë“œ","ì œëª©","ì±„ë„ëª…","êµ¬ë…ì","ì¡°íšŒìˆ˜","ì¢‹ì•„ìš”","ëŒ“ê¸€","ì°¸ì—¬ìœ¨(%)","ì˜ìƒURL"]
      ];
      CURRENT.forEach(v=>{
        rows.push([
          v.keyword,
          v.title.replace(/"/g,'""'),
          v.channelTitle.replace(/"/g,'""'),
          v.subscribers,
          v.views,
          v.likes,
          v.comments,
          v.engagement.toFixed(2),
          v.url
        ]);
      });

      const csv = rows.map(r => r.map(x => `"${x}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `youtube_analysis_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    /* ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© & ì´ˆê¸° ì‹¤í–‰ ====== */
    let CURRENT_DAYS = 3; // ì´ˆê¸° ê¸°ë³¸: 3ì¼ (ìš”ì²­í•˜ì‹  í”„ë¦¬ì…‹)
    $("#run").addEventListener("click", ()=> analyze(CURRENT_DAYS));
    $("#reset").addEventListener("click", showAll);
    $("#top10Eng").addEventListener("click", top10Engagement);
    $("#top10ViewsPct").addEventListener("click", top10ViewsPercent);
    $("#top10ViewsAbs").addEventListener("click", top10ViewsAbsolute);
    $("#exportCsv").addEventListener("click", exportCSV);

    $("#daysBtns").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-days]");
      if(!btn) return;
      $$("#daysBtns button").forEach(b=>b.classList.remove("btn-active"));
      btn.classList.add("btn-active");
      CURRENT_DAYS = Number(btn.dataset.days);
      analyze(CURRENT_DAYS);
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
    window.addEventListener("load", ()=> analyze(CURRENT_DAYS));
  </script>
</body>
</html>
