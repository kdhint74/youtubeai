<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YouTube 참여율 분석기</title>
<style>
  body { font-family: "맑은 고딕", sans-serif; background-color: #f7f7f7; padding: 30px; }
  h1 { color: #222; margin-bottom: 10px; }
  textarea, input { width: 100%; max-width: 400px; padding: 8px; margin-bottom: 10px; }
  button { background-color: #007bff; color: white; border: none; padding: 8px 14px; cursor: pointer; border-radius: 5px; }
  button:hover { background-color: #0056b3; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #007bff; color: white; }
  img { width: 120px; height: auto; border-radius: 4px; }
</style>
</head>
<body>

<h1>📊 YouTube 참여율 분석기</h1>

<label>키워드 (줄바꿈 구분):</label><br />
<textarea id="keywords" rows="3" placeholder="예: 건강정보&#10;트럼프 관세"></textarea><br />

<label>기간(일):</label><br />
<input type="number" id="days" value="7" /><br />

<button onclick="analyze()">분석 실행</button>
<button onclick="showAll()">전체 보기</button>
<button onclick="showTop10()">참여율 상위 10%만 보기</button>

<table id="resultTable">
  <thead>
    <tr>
      <th>썸네일</th>
      <th>키워드</th>
      <th>제목</th>
      <th>채널명 (구독자 수)</th>
      <th>조회수</th>
      <th>좋아요</th>
      <th>댓글</th>
      <th>참여율%</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_KEY = "YOUR_API_KEY_HERE";  // AIzaSyAMCdmq2Hz6z5da1QbzYVMf7W5uTATM9vg

let allResults = [];

const fmt = (n) => (n == null ? "-" : Number(n).toLocaleString("ko-KR"));
const pct = (n) => (n == null ? "-" : (Math.round(n * 100) / 100).toLocaleString("ko-KR"));

function renderTable(rows) {
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  for (const r of rows) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><a href="https://www.youtube.com/watch?v=${r.videoId}" target="_blank">
        <img src="${r.thumbnail}" /></a></td>
      <td>${r.keyword}</td>
      <td style="text-align:left;"><a href="https://www.youtube.com/watch?v=${r.videoId}" target="_blank">${r.title}</a></td>
      <td style="text-align:left;">${r.channelTitle} (${fmt(r.subscribers)})</td>
      <td>${fmt(r.views)}</td>
      <td>${fmt(r.likes)}</td>
      <td>${fmt(r.comments)}</td>
      <td>${pct(r.engagement)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function showTop10() {
  if (!allResults.length) return;
  const sorted = [...allResults].sort((a,b) => b.engagement - a.engagement);
  const top = Math.max(1, Math.floor(sorted.length * 0.1));
  renderTable(sorted.slice(0, top));
}

function showAll() {
  if (!allResults.length) return;
  const sorted = [...allResults].sort((a,b) => b.engagement - a.engagement);
  renderTable(sorted);
}

async function analyze() {
  if (!API_KEY || API_KEY.includes("YOUR_API_KEY_HERE")) {
    alert("API 키를 입력하세요.");
    return;
  }

  allResults = [];
  renderTable([]);

  const keywords = document.getElementById("keywords").value.split("\n").map(s => s.trim()).filter(Boolean);
  const days = parseInt(document.getElementById("days").value) || 7;
  const publishedAfter = new Date(Date.now() - days * 86400000).toISOString();

  for (const keyword of keywords) {
    const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(keyword)}&order=date&publishedAfter=${publishedAfter}&key=${API_KEY}`;
    const searchData = await (await fetch(searchUrl)).json();
    if (!searchData.items) continue;

    const videoIds = searchData.items.map(i => i.id.videoId).join(",");
    const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoIds}&key=${API_KEY}`;
    const videosData = await (await fetch(videosUrl)).json();

    const channelIds = [...new Set(videosData.items.map(v => v.snippet.channelId))];
    const channelSubs = await fetchChannelSubs(channelIds);

    for (const v of videosData.items) {
      const s = v.statistics || {};
      const views = Number(s.viewCount || 0);
      const likes = Number(s.likeCount || 0);
      const comments = Number(s.commentCount || 0);
      const engagement = views ? ((likes + comments) / views) * 100 : 0;
      allResults.push({
        keyword,
        videoId: v.id,
        title: v.snippet.title,
        thumbnail: v.snippet.thumbnails.medium.url,
        channelTitle: v.snippet.channelTitle,
        subscribers: channelSubs[v.snippet.channelId] || 0,
        views, likes, comments, engagement
      });
    }
  }
  showAll();
}

async function fetchChannelSubs(ids) {
  const map = {};
  for (let i = 0; i < ids.length; i += 50) {
    const chunk = ids.slice(i, i + 50).join(",");
    const res = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${chunk}&key=${API_KEY}`);
    const data = await res.json();
    for (const c of data.items || []) map[c.id] = Number(c.statistics.subscriberCount || 0);
  }
  return map;
}
</script>
</body>
</html>
